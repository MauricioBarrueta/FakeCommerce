<app-form [categories$]="categories$" (filterByCategory)="filterProductsByCategory($event)" (listProducts)="getFeaturedProducts($event)" (filterByType)="filterProductsByType($event)" (sortList)="sortListByTitle()"></app-form>

<div class="w-full flex flex-wrap justify-center">
    @for (product of products$ | async; track $index) {
        <div class="w-full max-w-sm relative bg-white border border-gray-200 rounded-lg p-4 shadow-sm dark:bg-gray-800 dark:border-gray-700">
            <a class="block relative" (click)="navService.getProductDetails(product.id)">
                <!--! AYER (28) PRESENTABA EL ERROR DE TOKEN AL DAR CLIC PARA VER DETALLES... -->
                <div class="relative cursor-pointer overflow-visible">
                    <img class="w-full h-[285px] object-contain hover:scale-105 transition duration-200 linear" src="{{product.thumbnail}}" alt="product image">
                    <span class="absolute top-[14%] right-0 bg-red-600 text-white text-xs font-bold px-10 py-1 transform rotate-45 translate-x-6 -translate-y-3 shadow-lg" [ngClass]="product.discountPercentage > 0 ? 'visible' : 'invisible'">
                        -{{ product.discountPercentage }}%
                    </span>
                </div>

            </a>

            <h5 class="text-xl font-semibold tracking-tight text-gray-900 dark:text-white">{{product.title}}</h5>
            <div class="flex items-center justify-end">
                <div class="flex items-center space-x-1 rtl:space-x-reverse">
                    @for (i of stars; track i) {
                        <i class="text-xs font-hairline ml-1" [ngClass]="rateIcon(product.rating, i)"></i>
                    }
                </div>
                <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-sm dark:bg-blue-200 dark:text-blue-800 ms-3">{{product.rating}}</span>
            </div>
            <div class="flex items-center justify-between flex-wrap">
                <span class="w-full line-through text-gray-400 mr-2">${{getOriginalPrice(product)}}</span>
                <span class="text-3xl font-bold text-gray-900 dark:text-white">${{product.price}}</span>
            </div>                
                
            <div class="relative flex items-center justify-between flex-wrap p-2 bg-red-500">
                <div class="flex">
                    <button class="w-[25px] h-auto p-0 bg-gray-200 rounded hover:bg-gray-300 text-sm" type="button" (click)="product.quantity = MathRef.max(1, (product.quantity ?? 1) - 1)">-</button>
                    <input type="number" [min]="1" [max]="product.stock" [(ngModel)]="product.quantity" [value]="product.quantity ?? 1" class="product-quantity w-16 text-center border rounded focus:ring-0 focus:outline-none [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none">
                    <button class="w-[25px] h-auto p-0 bg-gray-200 rounded hover:bg-gray-300 text-sm" type="button" (click)="product.quantity = MathRef.min(product.stock, (product.quantity ?? 1) + 1)">+</button>
                </div> 
                <div class="flex items-center flex-col">
                    <span>{{product.availabilityStatus}}</span>
                    <span class=" m-0 text-xs text-gray-500">({{ product.stock }} disponibles)</span>
                </div>
                <div class="flex">
                    <button type="button" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800" (click)="navService.onAddToCart(product)">&#xf07a;</button>
                    <button type="button" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">&#xf09d;</button>
                </div>
            </div>

            <div class="flex items-center justify-center flex-col">
                <p>{{product.shippingInformation}}</p>
                <p class="text-xs">{{product.warrantyInformation}}</p>
            </div>
        </div>
    }
</div>

<!--
    Flujo resumido en pasos
        Visitante:
            Home(Destacados) → Products → Product detail → (Login requerido para Cart/Profile)

        Usuario logueado:
            Home(Destacados) → Products → Product detail → Cart → Profile → Logout
-->